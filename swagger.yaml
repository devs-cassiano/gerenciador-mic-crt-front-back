openapi: 3.0.3
info:
  title: Sistema de Gestão de Transportadoras e Documentos
  description: |
    API para gerenciamento de transportadoras e geração de documentos CRT e MIC/DTA.
    
    ## Funcionalidades
    - Cadastro e gestão de transportadoras
    - Configuração de licenças por país de destino
    - Geração de documentos CRT
    - Geração de documentos MIC/DTA (NORMAL e LASTRE)
    - Numeração sequencial automática
    
    ## Tipos de MIC/DTA
    - **NORMAL**: Relacionado a um ou mais CRTs, herda todas as informações do primeiro CRT informado
    - **LASTRE**: Independente, para caminhões vazios (todas as transportadoras podem emitir)
    
  version: 1.0.0
  contact:
    name: Cassiano
    email: devs-cassiano@example.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT
servers:
  - url: http://localhost:3000/api
    description: Servidor de desenvolvimento

tags:
  - name: Transportadoras
    description: Gestão de transportadoras e licenças
  - name: CRT
    description: Certificado de Registro de Trânsito
  - name: MIC/DTA
    description: Manifesto Internacional de Carga / Documento de Transporte Aduaneiro
  - name: Configurações
    description: Configurações do sistema
components:
  schemas:
    NovoMicDtaNormal:
      type: object
      required:
        - tipo
        - crtIds
        - transportadoraId
        - paisOrigemCodigo
        - paisDestinoCodigo
      properties:
        tipo:
          type: string
          enum: [NORMAL]
          example: NORMAL
        crtIds:
          type: array
          description: Lista de IDs de CRTs a serem vinculados ao novo MIC-DTA
          items:
            type: integer
          example: [1,2,3]
        transportadoraId:
          type: integer
          example: 1
        paisOrigemCodigo:
          type: string
          example: "BR"
        paisDestinoCodigo:
          type: string
          example: "PY"
        licencaComplementar:
          type: string
          example: "6023"
    NovoMicDtaLastre:
      type: object
      required:
        - tipo
        - transportadoraId
        - paisOrigemCodigo
        - paisDestinoCodigo
        - quantidade
      properties:
        tipo:
          type: string
          enum: [LASTRE]
          example: LASTRE
        transportadoraId:
          type: integer
          example: 1
        paisOrigemCodigo:
          type: string
          example: "BR"
        paisDestinoCodigo:
          type: string
          example: "PY"
        quantidade:
          type: integer
          example: 2

    TransportadoraCompleta:
      allOf:
        - $ref: '#/components/schemas/NovaTransportadora'
        - type: object
          properties:
            id:
              type: integer
              example: 1
            createdAt:
              type: string
              format: date-time
              example: "2025-07-11T12:24:49.000Z"
            updatedAt:
              type: string
              format: date-time
              example: "2025-07-11T12:24:49.000Z"

    CRT:
      type: object
      properties:
        id:
          type: integer
          example: 1
        numero:
          type: string
          description: Número completo do CRT
          example: "BR602300001"
        paisOrigemCodigo:
          type: string
          example: "BR"
        paisDestinoCodigo:
          type: string
          example: "PY"
        licencaComplementar:
          type: string
          example: "6023"
        numeroSequencial:
          type: integer
          example: 1
        faturaComercial:
          type: string
          example: "FC-001"
        exportador:
          type: string
          example: "Empresa XYZ"
        importador:
          type: string
          example: "Empresa ABC"
        dataCriacao:
          type: string
          description: Data de criação (formato DD/MM/YYYY)
          example: "11/07/2025"
        transportadoraId:
          type: integer
          example: 1
        transportadoraNome:
          type: string
          example: "Transportes Brasil Ltda"
        transportadoraPais:
          type: string
          example: "BR"
        createdAt:
          type: string
          format: date-time
          example: "2025-07-11T12:24:49.000Z"

  responses:
    BadRequest:
      description: Requisição inválida
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            message: "Dados obrigatórios não informados"
            statusCode: 400

    NotFound:
      description: Recurso não encontrado
      content:
        application/json:
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              message:
                type: string
                example: "Recurso não encontrado"
              statusCode:
                type: integer
                example: 404

    InternalServerError:
      description: Erro interno do servidor
      content:
        application/json:
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              message:
                type: string
                example: "Erro interno do servidor"
              statusCode:
                type: integer
                example: 500


paths:
# DASHBOARD - Licenças e validade
  /dashboard/licencas-status:
    get:
      tags:
        - Transportadoras
      summary: Listar todas as licenças das empresas e validade
      description: |
        Retorna todas as licenças das transportadoras, classificando por status de validade:
        - **valid**: Licenças válidas (mais de 30 dias para vencer)
        - **expiringSoon**: Próximas a vencer (até 30 dias)
        - **expired**: Vencidas
        
        Útil para exibição no dashboard.
      responses:
        '200':
          description: Lista de licenças com status de validade
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  data:
                    type: object
                    properties:
                      all:
                        type: array
                        items:
                          $ref: '#/components/schemas/LicencaComStatus'
                      valid:
                        type: array
                        items:
                          $ref: '#/components/schemas/LicencaComStatus'
                      expiringSoon:
                        type: array
                        items:
                          $ref: '#/components/schemas/LicencaComStatus'
                      expired:
                        type: array
                        items:
                          $ref: '#/components/schemas/LicencaComStatus'
              example:
                success: true
                message: Licenças listadas com status de validade
                data:
                  all:
                    - id: 1
                      transportadora:
                        id: 1
                        nome: "Transportes Brasil Ltda"
                        pais: "BR"
                      paisDestino: "PY"
                      licenca: "6023"
                      idoneidade: "ID123"
                      vencimentoLicenca: "15/08/2025"
                      status: "valid"
                      diasParaVencer: 376
                  valid: []
                  expiringSoon:
                    - id: 2
                      transportadora:
                        id: 2
                        nome: "TransPY"
                        pais: "PY"
                      paisDestino: "BR"
                      licenca: "5500"
                      idoneidade: "ID789012"
                      vencimentoLicenca: "20/08/2025"
                      status: "expiringSoon"
                      diasParaVencer: 16
                  expired:
                    - id: 3
                      transportadora:
                        id: 1
                        nome: "Transportes Brasil Ltda"
                        pais: "BR"
                      paisDestino: "AR"
                      licenca: "6989"
                      idoneidade: "ID456"
                      vencimentoLicenca: "01/07/2025"
                      status: "expired"
                      diasParaVencer: -34
        '500':
          $ref: '#/components/responses/InternalServerError'


  # TRANSPORTADORAS
  /transportadoras:
    get:
      tags:
        - Transportadoras
      summary: Listar todas as transportadoras
      description: Retorna lista completa de transportadoras com suas licenças por destino
      responses:
        '200':
          description: Lista de transportadoras
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/TransportadoraCompleta'
              example:
                success: true
                data:
                  - id: 1
                    nome: "Transportes Brasil Ltda"
                    pais: "BR"
                    numeroRegistro: "12345678"
                    numeroInicialCRT: 11192
                    numeroInicialMicDta: 1
                    vencimentoLicenca: "2025-12-31"
                    paisesDestino:
                      - paisDestino: "PY"
                        licenca: "6023"
                      - paisDestino: "AR"
                        licenca: "6989"
                    createdAt: "2025-07-11T12:24:49.000Z"
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - Transportadoras
      summary: Criar nova transportadora
      description: Cria uma nova transportadora com licenças específicas por país de destino
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NovaTransportadora'
            examples:
              brasileira:
                summary: Transportadora Brasileira
                value:
                  nome: "Transportes Brasil Ltda"
                  pais: "BR"
                  numeroRegistro: "12345678"
                  numeroInicialCRT: 11192
                  numeroInicialMicDta: 1
                  paisesDestino:
                    - paisDestino: "PY"
                      licenca: "6023"
                      vencimentoLicenca: "2025-12-31"
                    - paisDestino: "AR"
                      licenca: "6989"
                      vencimentoLicenca: "2026-06-30"
              paraguaia:
                summary: Transportadora Paraguaia
                value:
                  nome: "Transportes Paraguay SA"
                  pais: "PY"
                  numeroRegistro: "87654321"
                  numeroInicialCRT: 1
                  numeroInicialMicDta: 1
                  paisesDestino:
                    - paisDestino: "BR"
                      licenca: "5500"
                      idoneidade: "ID789012"
                      vencimentoLicenca: "2025-11-15"
                    - paisDestino: "AR"
                      licenca: "5501"
                      idoneidade: "ID789013"
                      vencimentoLicenca: "2026-03-20"
      responses:
        '201':
          description: Transportadora criada com sucesso
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/TransportadoraCompleta'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /transportadoras/{id}:
    get:
      tags:
        - Transportadoras
      summary: Buscar transportadora por ID
      parameters:
        - $ref: '#/components/parameters/TransportadoraId'
      responses:
        '200':
          description: Transportadora encontrada
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/TransportadoraCompleta'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      tags:
        - Transportadoras
      summary: Atualizar transportadora
      parameters:
        - $ref: '#/components/parameters/TransportadoraId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NovaTransportadora'
      responses:
        '200':
          description: Transportadora atualizada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessMessage'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags:
        - Transportadoras
      summary: Deletar transportadora
      parameters:
        - $ref: '#/components/parameters/TransportadoraId'
      responses:
        '200':
          description: Transportadora deletada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessMessage'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  # CRT
  /crt:
    get:
      tags:
        - CRT
      summary: Listar todos os CRTs
      responses:
        '200':
          description: Lista de CRTs
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/CRT'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - CRT
      summary: Criar novo CRT
      description: |
        Cria um ou múltiplos CRTs para uma transportadora específica.
        O país de destino é obrigatório para definir qual licença será usada.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NovoCRT'
            example:
              transportadoraId: 1
              quantidade: 2
              faturaComercial: "FC-001"
              exportador: "Empresa XYZ"
              importador: "Empresa ABC"
              paisOrigemCodigo: "BR"
              paisDestinoCodigo: "PY"
      responses:
        '201':
          description: CRT(s) criado(s) com sucesso
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/CRT'
                  message:
                    type: string
                    example: "2 CRT(s) criado(s) com sucesso"
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /crt/{id}:
    get:
      tags:
        - CRT
      summary: Buscar CRT por ID
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: ID do CRT
      responses:
        '200':
          description: CRT encontrado
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/CRT'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /crt/transportadora/{transportadoraId}:
    get:
      tags:
        - CRT
      summary: Buscar CRTs por transportadora
      parameters:
        - $ref: '#/components/parameters/TransportadoraId'
      responses:
        '200':
          description: CRTs da transportadora
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/CRT'
        '500':
          $ref: '#/components/responses/InternalServerError'

  # MIC/DTA
  /mic-dta:
    get:
      tags:
        - MIC/DTA
      summary: Listar todos os MIC/DTAs
      responses:
        '200':
          description: Lista de MIC/DTAs
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/MicDta'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - MIC/DTA
      summary: Criar novo MIC/DTA
      description: |
        Cria um ou múltiplos MIC/DTAs. Suporta dois tipos:
        
        **NORMAL**: Relacionado a um CRT existente, herda todas as informações
        **LASTRE**: Independente, para caminhões vazios (todas as transportadoras podem emitir)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/NovoMicDtaNormal'
                - $ref: '#/components/schemas/NovoMicDtaLastre'
              discriminator:
                propertyName: tipo
            examples:
              normal:
                summary: MIC/DTA NORMAL (vincula 1 ou mais CRTs existentes)
                value:
                  tipo: "NORMAL"
                  crtIds: [1,2]
                  transportadoraId: 1
                  paisOrigemCodigo: "BR"
                  paisDestinoCodigo: "PY"
                  licencaComplementar: "6023"
              lastre:
                summary: MIC/DTA LASTRE (caminhão vazio)
                value:
                  tipo: "LASTRE"
                  transportadoraId: 1
                  paisOrigemCodigo: "BR"
                  paisDestinoCodigo: "PY"
                  quantidade: 2
              lastre_estrangeira:
                summary: MIC/DTA LASTRE (transportadora estrangeira)
                value:
                  tipo: "LASTRE"
                  transportadoraId: 2
                  paisOrigemCodigo: "PY"
                  paisDestinoCodigo: "BR"
                  quantidade: 1
      responses:
        '201':
          description: MIC/DTA(s) criado(s) com sucesso
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/RespostaMicDtaNormal'
                  - $ref: '#/components/schemas/RespostaMicDtaLastre'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /mic-dta/tipo/{tipo}:
    get:
      tags:
        - MIC/DTA
      summary: Buscar MIC/DTAs por tipo
      parameters:
        - name: tipo
          in: path
          required: true
          schema:
            type: string
            enum: [NORMAL, LASTRE]
          description: Tipo do MIC/DTA
      responses:
        '200':
          description: MIC/DTAs do tipo especificado
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/MicDta'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /mic-dta/transportadora/{transportadoraId}:
    get:
      tags:
        - MIC/DTA
      summary: Buscar MIC/DTAs por transportadora
      parameters:
        - $ref: '#/components/parameters/TransportadoraId'
      responses:
        '200':
          description: MIC/DTAs da transportadora
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/MicDta'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /mic-dta/crt/{crtId}:
    get:
      tags:
        - MIC/DTA
      summary: Buscar MIC/DTAs relacionados a um CRT
      description: Retorna apenas MIC/DTAs do tipo NORMAL relacionados ao CRT especificado
      parameters:
        - name: crtId
          in: path
          required: true
          schema:
            type: integer
          description: ID do CRT
      responses:
        '200':
          description: MIC/DTAs relacionados ao CRT
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/MicDta'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /mic-dta/next-number/{transportadoraId}:
    get:
      tags:
        - MIC/DTA
      summary: Obter próximo número sequencial do MIC/DTA
      description: Retorna o próximo número sequencial que será usado na criação de um MIC/DTA para a transportadora especificada
      parameters:
        - name: transportadoraId
          in: path
          required: true
          schema:
            type: integer
          description: ID da transportadora
        - name: paisOrigemCodigo
          in: query
          required: false
          schema:
            type: string
          description: Código do país de origem (se não informado, usa o país da transportadora)
          example: "BR"
        - name: paisDestinoCodigo
          in: query
          required: true
          schema:
            type: string
          description: Código do país de destino
          example: "AR"
        - name: licencaComplementar
          in: query
          required: false
          schema:
            type: string
          description: Licença complementar (se não informada, busca pela transportadora)
          example: "ABC123"
      responses:
        '200':
          description: Próximo número sequencial
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: object
                    properties:
                      numeroCompleto:
                        type: string
                        description: Número completo formatado
                        example: "BR.01.001.AR.ABC123"
                      numeroSequencial:
                        type: integer
                        description: Número sequencial
                        example: 1
                      paisOrigemCodigo:
                        type: string
                        description: Código do país de origem
                        example: "BR"
                      paisDestinoCodigo:
                        type: string
                        description: Código do país de destino
                        example: "AR"
                      licencaComplementar:
                        type: string
                        description: Licença complementar
                        example: "ABC123"
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  # CONFIGURAÇÕES
  /countries:
    get:
      tags:
        - Configurações
      summary: Listar países disponíveis
      description: Retorna lista de países suportados pelo sistema
      responses:
        '200':
          description: Lista de países
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Pais'
              example:
                success: true
                data:
                  - code: "BR"
                    name: "Brasil"
                  - code: "PY"
                    name: "Paraguay"
                  - code: "AR"
                    name: "Argentina"


  responses:
    BadRequest:
      description: Requisição inválida
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            message: "Dados obrigatórios não informados"
            statusCode: 400

    NotFound:
      description: Recurso não encontrado
      content:
        application/json:
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              message:
                type: string
                example: "Recurso não encontrado"
              statusCode:
                type: integer
                example: 404

    InternalServerError:
      description: Erro interno do servidor
      content:
        application/json:
          schema:
            type: object
            properties:
              success:
                type: boolean
                example: false
              message:
                type: string
                example: "Erro interno do servidor"
              statusCode:
                type: integer
                example: 500


  /mic-dta/{micDtaId}/crts:
    get:
      tags:
        - MIC/DTA
      summary: Listar CRTs vinculados a um MIC/DTA
      description: Retorna todos os CRTs associados ao MIC/DTA informado.
      parameters:
        - name: micDtaId
          in: path
          required: true
          schema:
            type: integer
          description: ID do MIC/DTA
      responses:
        '200':
          description: Lista de CRTs vinculados ao MIC/DTA
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/CRT'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    patch:
      tags:
        - MIC/DTA
      summary: Associar CRTs a um MIC/DTA existente
      description: Associa um ou mais CRTs a um MIC/DTA já criado.
      parameters:
        - name: micDtaId
          in: path
          required: true
          schema:
            type: integer
          description: ID do MIC/DTA
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                crtIds:
                  type: array
                  items:
                    type: integer
                  description: Lista de IDs dos CRTs a associar
            example:
              crtIds: [1, 2, 3]
      responses:
        '200':
          description: CRTs associados com sucesso
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: CRTs associados ao MIC/DTA com sucesso
                  data:
                    type: object
                    properties:
                      micDtaId:
                        type: integer
                        example: 1
                      crtIds:
                        type: array
                        items:
                          type: integer
                        example: [1, 2, 3]
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
